; Chip config
.EQU	RC_CLOCK_CALIBRATE	=	0x3D


; App config
.EQU	FOSC			=	1000000
.EQU	BAUD			=	2400
.EQU	USART_SCALE		=	FOSC/16/BAUD-1


; Interrupt vector
.ORG	0x0000	JMP	VEC_RESET		;Not used due to bootloader
.ORG	0x0002	JMP	VEC_EXT_INT0
.ORG	0x0004	JMP	VEC_EXT_INT1
.ORG	0x0006	JMP	VEC_PCINT0
.ORG	0x0008	JMP	VEC_PCINT1
.ORG	0x000A	JMP	VEC_PCINT2
.ORG	0x000C	JMP	VEC_WDT
.ORG	0x000E	JMP	VEC_TIM2_COMPA
.ORG	0x0010	JMP	VEC_TIM2_COMPB
.ORG	0x0012	JMP	VEC_TIM2_OVF
.ORG	0x0014	JMP	VEC_TIM2_CAPT
.ORG	0x0016	JMP	VEC_TIM1_COMPA
.ORG	0x0018	JMP	VEC_TIM1_COMPB
.ORG	0x001A	JMP	VEC_TIM1_OVF
.ORG	0x001C	JMP	VEC_TIM0_COMPA
.ORG	0x001E	JMP	VEC_TIM0_COMPB
.ORG	0x0020	JMP	VEC_TIM0_OVF
.ORG	0x0022	JMP	VEC_SPI_STC
.ORG	0x0024	JMP	VEC_USART_RXC
.ORG	0x0026	JMP	VEC_USART_UDRE
.ORG	0x0028	JMP	VEC_USART_TXC
.ORG	0x002A	JMP	VEC_ADC
.ORG	0x002C	JMP	VEC_EE_RDY
.ORG	0x002E	JMP	VEC_ANA_COMP
.ORG	0x0030	JMP	VEC_TWI
.ORG	0x0032	JMP	VEC_SPM_RDY


; External functions
#include "func_usart.inc"


; App program ----------------------------------------------

; Unused vector
VEC_EXT_INT0:
	LDI	R17, 0x01
VEC_EXT_INT1:
VEC_PCINT0:
VEC_PCINT1:
VEC_PCINT2:
VEC_WDT:
VEC_TIM2_COMPA:
VEC_TIM2_COMPB:
VEC_TIM2_OVF:
VEC_TIM2_CAPT:
VEC_TIM1_COMPA:
VEC_TIM1_COMPB:
VEC_TIM1_OVF:
VEC_TIM0_COMPA:
VEC_TIM0_COMPB:
VEC_TIM0_OVF:
VEC_SPI_STC:
VEC_USART_RXC:
VEC_USART_UDRE:
VEC_USART_TXC:
VEC_ADC:
VEC_EE_RDY:
VEC_ANA_COMP:
VEC_TWI:
VEC_SPM_RDY:


; Config MCU
VEC_RESET:
INI:
	;Setup SP
	LDI	R16, HIGH(RAMEND)
	OUT	SPH, R16
	LDI	R16, LOW(RAMEND)
	OUT	SPL, R16

	;Setup interrupt mode
;	LDI	R16, 0x02
;	OUT	MCUCR, R16
;	LDI	R16, 0x01
;	OUT	MCUCR, R16

	;Calibrate clock and set pre-scaler
	LDI	R16, RC_CLOCK_CALIBRATE
	STS	OSCCAL, R16

	LDI	R16, 0x80
	STS	CLKPR, R16
	LDI	R16, 0x03			;1/8 pre-scaler, sys clock = 1.0MHz
	STS	CLKPR, R16

	;Setup USART communication with operator-side controller
	LDI	R16, HIGH(USART_SCALE)
	STS	UBRR0H, R16
	LDI	R16, LOW(USART_SCALE)
	STS	UBRR0L, R16
	LDI	R16, 0b10011000			;Enable Tx/Rx and Rx interrupt, 8 bits data
	STS	UCSR0B, R16
	LDI	R16, 0b00101110			;Async USART (UART), even parity, 2 stop bits, 8 bits data
	STS	UCSR0C, R16


	SEI					;Ini done, enable interrupt


; Main function
MAIN:
	LDI	R16, 'A'
	CALL	FUNC_USATR_SENDCHAR
	
	

; End of app
END:
	JMP	END
